name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Extract changelog for version
      id: changelog
      run: |
        VERSION=${{ steps.get_version.outputs.version }}

        # Extract changelog section for this version
        CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d')

        # If changelog is empty, use a default message
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="Release version $VERSION"
        fi

        # Write to file to preserve multiline
        echo "$CHANGELOG" > changelog_section.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: changelog_section.txt
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-notification:
    name: Notify on Release
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create release summary
      run: |
        cat << EOF >> $GITHUB_STEP_SUMMARY
        # ðŸŽ‰ Release v${{ steps.get_version.outputs.version }} Published!

        ## Installation

        Users can now install this version via:

        ### ComfyUI Manager
        \`\`\`
        Search for "Pipemind" in ComfyUI Manager and update
        \`\`\`

        ### Manual Installation
        \`\`\`bash
        cd ComfyUI/custom_nodes/pipemind-comfyui
        git fetch --tags
        git checkout v${{ steps.get_version.outputs.version }}
        pip install -r requirements.txt --upgrade
        \`\`\`

        ## Release Notes

        See the [full release notes](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }})
        EOF

  test-release:
    name: Test Release Installation
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Checkout release tag
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install and test
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

        # Test imports
        python -c "import __init__; print(f'âœ“ Successfully loaded {len(__init__.NODE_CLASS_MAPPINGS)} nodes')"

        # Run smoke tests
        pip install pytest
        pytest tests/ -m smoke -v || echo "Note: Some tests may require ComfyUI environment"
